<!DOCTYPE html><html data-githubContributorsUrl="https://api.github.com/repos/Katrix/perspective" data-githubContributorsFilename="docs/_docs/guide/03_inlinehkdgeneric.md" data-pathToRoot=""><head><meta charset="utf-8"></meta><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"></meta><title>InlineHKDGeneric </title><link rel="shortcut icon" type="image/x-icon" href="favicon.ico"></link><script type="text/javascript" src="scripts/theme.js"></script><script type="text/javascript" src="scripts/searchData.js" defer="true"></script><script type="text/javascript" src="scripts/scastieConfiguration.js" defer="true"></script><link rel="stylesheet" href="styles/theme/bundle.css"></link><link rel="stylesheet" href="styles/theme/components/bundle.css"></link><link rel="stylesheet" href="styles/theme/components/button/bundle.css"></link><link rel="stylesheet" href="styles/theme/layout/bundle.css"></link><link rel="stylesheet" href="styles/nord-light.css"></link><link rel="stylesheet" href="styles/dotty-icons.css"></link><link rel="stylesheet" href="styles/filter-bar.css"></link><link rel="stylesheet" href="styles/code-snippets.css"></link><link rel="stylesheet" href="styles/searchbar.css"></link><link rel="stylesheet" href="styles/social-links.css"></link><link rel="stylesheet" href="styles/versions-dropdown.css"></link><link rel="stylesheet" href="styles/content-contributors.css"></link><link rel="stylesheet" href="styles/fontawesome.css"></link><script type="text/javascript" src="hljs/highlight.pack.js" defer="true"></script><script type="text/javascript" src="scripts/hljs-scala3.js" defer="true"></script><script type="text/javascript" src="scripts/ux.js" defer="true"></script><script type="text/javascript" src="scripts/common/component.js" defer="true"></script><script type="text/javascript" src="scripts/common/utils.js" defer="true"></script><script type="text/javascript" src="scripts/components/FilterBar.js" defer="true"></script><script type="text/javascript" src="scripts/components/DocumentableList.js" defer="true"></script><script type="text/javascript" src="scripts/components/Input.js" defer="true"></script><script type="text/javascript" src="scripts/components/FilterGroup.js" defer="true"></script><script type="text/javascript" src="scripts/components/Filter.js" defer="true"></script><script type="text/javascript" src="scripts/scaladoc-scalajs.js" defer="true"></script><script type="text/javascript" src="scripts/contributors.js" defer="true"></script><script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js" defer="true"></script><script type="text/javascript" src="https://d3js.org/d3.v6.min.js" defer="true"></script><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/graphlib-dot@0.6.2/dist/graphlib-dot.min.js" defer="true"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/dagre-d3/0.6.1/dagre-d3.min.js" defer="true"></script><script type="text/javascript" src="https://scastie.scala-lang.org/embedded.js" defer="true"></script><script type="text/javascript" src="scripts/data.js" defer="true"></script><link rel="stylesheet" href="styles/staticsitestyles.css"></link><script>var pathToRoot = "";</script></head><body><div id=""><div id="header" class="body-small"><div class="header-container-left"><a href="" class="logo-container"><span class="project-name h300">perspective</span></a><span onclick="dropdownHandler(event)" class="text-button with-arrow" id="dropdown-trigger"><a><div class="projectVersion">0.2.0+21-407b962d-SNAPSHOT</div></a></span><div id="version-dropdown" class="dropdown-menu"></div></div><div class="header-container-right"><button id="search-toggle" class="icon-button"></button><span id="theme-toggle" class="icon-button"></span><span id="mobile-menu-toggle" class="icon-button hamburger"></span></div></div><div id="mobile-menu"><div class="mobile-menu-header body-small"><span class="mobile-menu-logo"><span class="project-name h300">perspective</span></span><button id="mobile-menu-close" class="icon-button close"></button></div><div class="mobile-menu-container body-medium"><input id="mobile-scaladoc-searchbar-input" class="scaladoc-searchbar-input" type="search" placeholder="Find anything"></input><span id="mobile-theme-toggle" class="mobile-menu-item mode"></span></div></div><span id="mobile-sidebar-toggle" class="floating-button"></span><div id="leftColumn" class="body-small"><div class="switcher-container"><a id="docs-nav-button" class="switcher h100 selected" href="index.html">Docs</a><a id="api-nav-button" class="switcher h100 " href="api/index.html">API</a></div><nav id="docs-nav" class="side-menu"><div class="ni n0 "><span class="nh de"><a href="01_typeclasses.html"><span>Typeclasses </span></a></span></div><div class="ni n0 "><span class="nh de"><a href="02_hkdgeneric.html"><span>HKDGeneric </span></a></span></div><div class="ni n0 expanded"><span class="nh h100 selected de"><a href="#"><span>InlineHKDGeneric </span></a></span></div><div class="ni n0 "><span class="nh de"><a href="04_exprhkdgeneric.html"><span>ExprHKDGeneric </span></a></span></div></nav></div><div id="footer" class="body-small"><div class="left-container">Generated with</div><div class="right-container"><a href="https://github.com/Katrix/perspective"><button class="icon-button gh"></button></a><div class="text"></div></div><div class="text-mobile"></div></div><div id="scaladoc-searchBar"></div><div id="main"><div class="breadcrumbs container"><a href="index.html">perspective</a>/<a href="03_inlinehkdgeneric.html">InlineHKDGeneric </a></div><div id="content" class="body-medium"><div><section id="inlinehkdgeneric-1">
 <h1 class="h500"><a href="#inlinehkdgeneric-1" class="anchor"></a>InlineHKDGeneric</h1>
 <p><code>perspective</code> provides some special instances of <code>HKDGeneric</code> for other or more specialized purposes. <code>InlineHKDGeneric</code> is one example here, and provides a variant of <code>HKDGeneric</code> to be used in inline functions, and generate nicer and often faster bytecode.</p>
 <p><code>InlineHKDGeneric</code> reimplements all the functions defined in typeclasses on <code>InlineHKDGeneric</code> itself.</p>
 <p>InlineHKDProductGeneric uses a lot of beta reduction to simplify code and avoid lambdas in the generated code. At the time of writing InlineHKDGeneric, this beta reduction did not work with polymorphic functions. perspective gets around this by representing the <code>Index</code> type differently using path dependent types. Because of this, use of <code>tabulate</code> functions is heavily recommended when using <code>InlineHKDGeneric</code> Non-tabulate functions are still left in the API but might not generate as good bytecode.</p>
</section>
<section id="implicits-1">
 <h2 class="h500"><a href="#implicits-1" class="anchor"></a>Implicits</h2>
 <p>Implicit instances of <code>Gen[F]</code> is gotten using the function <code>gen.summonInstances[F]</code> when working with <code>InlineHKDGeneric</code>.</p>
</section>
<section id="unrolling-1">
 <h2 class="h500"><a href="#unrolling-1" class="anchor"></a>Unrolling</h2>
 <p><code>InlineHKDGeneric</code> can in some cases perform loop unrolling if instructed to. Some <code>tabulate</code> functions have another paramete <code>unroll: Boolean = false</code>. Setting this parameter to true will unroll the loop perspective generates. When doing loop unrolling, the code can be specialized based on the current type being worked on. To do this, two extra functions are used, <code>productElementIdExact</code> and <code>lateInlineMatch</code>. <code>productElementIdExact</code> works like <code>productElementId</code> but refines the type when used within an unrolled block. <code>lateInlineMatch</code> is like an <code>inline match</code>, but expands slightly later, after the type of <code>productElementIdExact</code> has been refined.</p>
</section>
<section id="example-2">
 <h3 class="h400"><a href="#example-2" class="anchor"></a>Example</h3>
 <div class="snippet mono-small-block" scala-snippet="">
  <pre><code class="language-scala"><span line-number="1" class=""><span class="tooltip-container"></span>trait PerspectiveInlineEncoder[A] extends Encoder[A]
</span><span line-number="2" class=""><span class="tooltip-container"></span>object PerspectiveInlineEncoder:
</span><span line-number="3" class=""><span class="tooltip-container"></span>
</span><span line-number="4" class=""><span class="tooltip-container"></span>  inline def derivedProductEncoder[A](using gen: InlineHKDProductGeneric[A]): PerspectiveInlineEncoder[A] =
</span><span line-number="5" class=""><span class="tooltip-container"></span>    new PerspectiveInlineEncoder[A]:
</span><span line-number="6" class=""><span class="tooltip-container"></span>      private val names    = gen.names
</span><span line-number="7" class=""><span class="tooltip-container"></span>      private val encoders = gen.summonInstances[Encoder]
</span><span line-number="8" class=""><span class="tooltip-container"></span>
</span><span line-number="9" class=""><span class="tooltip-container"></span>      override def apply(a: A): Json =
</span><span line-number="10" class=""><span class="tooltip-container"></span>        val list = gen.tabulateFoldLeft(Nil: List[(String, Json)], unrolling = true)((acc, idx) =&gt;
</span><span line-number="11" class=""><span class="tooltip-container"></span>          val js = gen.lateInlineMatch {
</span><span line-number="12" class=""><span class="tooltip-container"></span>            a.productElementIdExact(idx) match {
</span><span line-number="13" class=""><span class="tooltip-container"></span>              case p: Byte    =&gt; Json.fromInt(p)
</span><span line-number="14" class=""><span class="tooltip-container"></span>              case p: Char    =&gt; Json.fromString(p.toString)
</span><span line-number="15" class=""><span class="tooltip-container"></span>              case p: Short   =&gt; Json.fromInt(p)
</span><span line-number="16" class=""><span class="tooltip-container"></span>              case p: Int     =&gt; Json.fromInt(p)
</span><span line-number="17" class=""><span class="tooltip-container"></span>              case p: Long    =&gt; Json.fromLong(p)
</span><span line-number="18" class=""><span class="tooltip-container"></span>              case p: Float   =&gt; Json.fromFloatOrString(p)
</span><span line-number="19" class=""><span class="tooltip-container"></span>              case p: Double  =&gt; Json.fromDoubleOrString(p)
</span><span line-number="20" class=""><span class="tooltip-container"></span>              case p: Boolean =&gt; Json.fromBoolean(p)
</span><span line-number="21" class=""><span class="tooltip-container"></span>              case p: String  =&gt; Json.fromString(p)
</span><span line-number="22" class=""><span class="tooltip-container"></span>              case other      =&gt; encoders.indexK(idx)(other)
</span><span line-number="23" class=""><span class="tooltip-container"></span>            }
</span><span line-number="24" class=""><span class="tooltip-container"></span>          }
</span><span line-number="25" class=""><span class="tooltip-container"></span>
</span><span line-number="26" class=""><span class="tooltip-container"></span>          (names.indexK(idx), js) :: acc
</span><span line-number="27" class=""><span class="tooltip-container"></span>        )
</span><span line-number="28" class=""><span class="tooltip-container"></span>
</span><span line-number="29" class=""><span class="tooltip-container"></span>        Json.obj(list: _*)
</span><span line-number="30" class=""><span class="tooltip-container"></span>
</span><span line-number="31" class=""><span class="tooltip-container"></span>  inline def derived[A](using gen: InlineHKDGeneric[A]): PerspectiveInlineEncoder[A] = inline gen match
</span><span line-number="32" class=""><span class="tooltip-container"></span>    case gen: InlineHKDProductGeneric.Aux[A, gen.Gen] =&gt; derivedProductEncoder(using gen)
</span></code></pre>
  <div class="buttons"></div>
 </div>
</section></div><div id="toc" class="body-small"><div id="toc-container"><span class="toc-title h200">In this article</span><nav class="toc-nav"><ul class="toc-list"><li><a href="#inlinehkdgeneric-1">InlineHKDGeneric</a><ul><li><a href="#implicits-1">Implicits</a></li><li><a href="#unrolling-1">Unrolling</a><ul><li><a href="#example-2">Example</a></li></ul></li></ul></li></ul></nav></div></div></div><div id="footer" class="body-small mobile-footer"><div class="left-container">Generated with</div><div class="right-container"><a href="https://github.com/Katrix/perspective"><button class="icon-button gh"></button></a><div class="text"></div></div><div class="text-mobile"></div></div></div></div></body></html>